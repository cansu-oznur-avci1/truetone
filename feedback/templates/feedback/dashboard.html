{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container py-5">
    <div class="row mb-5 animate__animated animate__fadeIn">
        <div class="col-lg-12">
            <div class="main-banner p-5 rounded-5 border-0 shadow-lg text-white position-relative overflow-hidden text-start shadow-hover">
                <div class="position-relative z-index-2">
                    <h1 class="display-5 fw-bold mb-2">
                        {% if is_admin %}Admin Intelligence Dashboard{% else %}Service Analytics Dashboard{% endif %}
                    </h1>
                    <p class="lead opacity-75">Real-time monitoring & AI-driven sentiment analysis.</p>
                </div>
                <div class="banner-circle"></div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5 text-start d-flex align-items-stretch">
        <div class="col-md-8">
            <div class="row g-4 h-100">
                <div class="col-md-6">
                    <div class="card h-100 border-0 shadow-sm rounded-4 stat-card-premium bg-white p-4 hover-lift d-flex flex-column justify-content-center">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="text-muted small fw-bold text-uppercase mb-2">Total Feedbacks</h6>
                                <h2 class="fw-black text-dark mb-0">{{ feedbacks|length }}</h2>
                            </div>
                            <div class="icon-wrap bg-primary-subtle text-primary rounded-pill p-3"><i class="fas fa-comments fa-lg"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 border-0 shadow-sm rounded-4 stat-card-premium bg-white p-4 hover-lift d-flex flex-column justify-content-center">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="text-muted small fw-bold text-uppercase mb-2">AI Status</h6>
                                <h2 class="fw-black text-success mb-0">OPTIMIZED</h2>
                            </div>
                            <div class="icon-wrap bg-success-subtle text-success rounded-pill p-3"><i class="fas fa-robot fa-lg"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="card border-0 shadow-sm rounded-4 stat-card-premium bg-white p-4 hover-lift d-flex flex-column justify-content-center">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="fw-bold mb-1 text-dark">Data Governance & Privacy</h5>
                                <p class="mb-0 text-muted small">Role-Based Access Control (RBAC) is active. Student identities are masked.</p>
                            </div>
                            <h2 class="fw-black text-info mb-0 ms-3">ENABLED</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm rounded-4 bg-white p-4 text-center hover-lift d-flex flex-column shadow-hover">
                <h6 class="text-muted small fw-bold text-uppercase mb-3">{{ chart_title }}</h6>
                <div class="flex-grow-1 d-flex align-items-center justify-content-center">
                    <canvas id="dynamicChart" style="max-height: 250px; width: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 p-3 mb-4 bg-white shadow-hover border-start border-primary border-4">
        <form method="GET" class="row g-3 align-items-end text-start mx-1">
            <div class="col-lg-3">
                <label class="small fw-bold text-muted mb-1 ms-1">{% if is_admin %}Service / Keyword{% else %}Keyword Search{% endif %}</label>
                <div class="input-group bg-light rounded-3">
                    <span class="input-group-text bg-transparent border-0 pe-0"><i class="fas fa-search text-muted small"></i></span>
                    <input type="text" name="q" value="{{ request.GET.q }}" class="form-control border-0 bg-transparent shadow-none ps-2" placeholder="Search...">
                </div>
            </div>
            <div class="col-lg-2">
                <label class="small fw-bold text-muted mb-1 ms-1">Start Date</label>
                <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control border-0 bg-light shadow-none rounded-3">
            </div>
            <div class="col-lg-2">
                <label class="small fw-bold text-muted mb-1 ms-1">End Date</label>
                <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control border-0 bg-light shadow-none rounded-3">
            </div>
            {% if is_admin %}
            <div class="col-lg-2">
                <label class="small fw-bold text-muted mb-1 ms-1">Target Service</label>
                <select name="service_filter" class="form-select border-0 bg-light shadow-none rounded-3 text-muted fw-medium">
                    <option value="">Global (All Services)</option>
                    {% for s in all_services %}
                        <option value="{{ s.id }}" {% if request.GET.service_filter == s.id|stringformat:"i" %}selected{% endif %}>
                            {{ s.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-lg-2">
                <label class="small fw-bold text-muted mb-1 ms-1">Severity</label>
                <select name="severity" class="form-select border-0 bg-light shadow-none rounded-3 text-muted fw-medium">
                    <option value="">All Levels</option>
                    <option value="4" {% if request.GET.severity == "4" %}selected{% endif %}>Critical (L4)</option>
                    <option value="3" {% if request.GET.severity == "3" %}selected{% endif %}>High (L3)</option>
                    <option value="2" {% if request.GET.severity == "2" %}selected{% endif %}>Medium (L2)</option>
                    <option value="1" {% if request.GET.severity == "1" %}selected{% endif %}>Low (L1)</option>
                </select>
            </div>
            <div class="col-lg-3">
                <button type="submit" class="btn btn-primary w-100 rounded-3 fw-bold py-2 shadow-sm hover-push transition-all">
                    <i class="fas fa-filter me-2"></i>APPLY ANALYTICS
                </button>
            </div>
        </form>
    </div>

    <div class="card border-0 shadow-lg rounded-5 overflow-hidden animate__animated animate__slideInUp">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-5 py-4 text-muted small fw-bold text-uppercase">Service Node</th>
                        <th class="py-4 text-muted small fw-bold text-uppercase text-center">Severity</th>
                        <th class="py-4 text-muted small fw-bold text-uppercase text-center" style="width: 45%;">AI Analysis Result</th>
                        <th class="pe-5 py-4 text-muted small fw-bold text-uppercase text-end">Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fb in feedbacks %}
                    <tr class="hover-row-glow transition-all">
                        <td class="ps-5">
                            <div class="d-flex align-items-center">
                                <div class="avatar-icon text-white">{{ fb.service.name|slice:":1" }}</div>
                                <div class="ms-3">
                                    <div class="fw-bold text-dark">{{ fb.service.name }}</div>
                                    <small class="badge bg-primary-subtle text-primary rounded-pill px-2" style="font-size: 0.6rem;">{{ fb.category|upper }}</small>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge rounded-pill px-3 py-2 
                                {% if fb.severity >= 4 %} bg-danger 
                                {% elif fb.severity == 3 %} bg-warning text-dark 
                                {% elif fb.severity == 2 %} bg-info-custom text-white 
                                {% else %} bg-success {% endif %}">
                                Level {{ fb.severity }}
                            </span>
                        </td>
                        <td class="text-center px-4">
                            <div class="p-3 rounded-4 bg-light border-0 ai-bubble shadow-sm w-100 transition-all">
                                <p class="mb-0 text-secondary small italic">
                                    {{ fb.normalized_text|default:fb.raw_text|truncatechars:180 }}
                                </p>
                            </div>
                        </td>
                        <td class="pe-5 text-end small">
                            <div class="fw-bold text-dark">{{ fb.date|date:"M d, Y" }}</div>
                            <div class="text-muted">{{ fb.date|date:"H:i A" }}</div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="py-5 text-center text-muted">No data available for the current selection.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
    body { background-color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; }
    .main-banner { background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%); transition: 0.4s; }
    .banner-circle { position: absolute; top: -50px; right: -50px; width: 250px; height: 250px; background: rgba(255,255,255,0.08); border-radius: 50%; }
    
    .hover-lift:hover { transform: translateY(-8px); box-shadow: 0 1rem 3rem rgba(0,0,0,0.12) !important; cursor: pointer; }
    .hover-row-glow:hover { background-color: #ffffff !important; box-shadow: inset 4px 0 0 #2563eb; }
    .transition-all { transition: all 0.3s ease-in-out; }
    
    .avatar-icon { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; font-weight: 800; border-radius: 12px; background-color: #1e293b; }
    .ai-bubble { border: 1px solid transparent !important; }
    tr:hover .ai-bubble { background-color: #fff !important; border-color: #e2e8f0 !important; }
    .bg-info-custom { background-color: #0ea5e9 !important; }
    .fw-black { font-weight: 800; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('dynamicChart').getContext('2d');
        const rawLabels = {{ labels|safe }};
        
        // Severity seviyelerine göre sabit renkler tanımlıyoruz
        const severityPalette = {
            'Level 4': '#ef4444', // Red
            'Level 3': '#f59e0b', // Amber
            'Level 2': '#0ea5e9', // Blue
            'Level 1': '#10b981'  // Emerald
        };

        // Servis dağılımı (Admin Global View) için canlı ve zıt renk paleti
        const servicePalette = [
            '#6366f1', // Indigo
            '#ec4899', // Pembe
            '#8b5cf6', // Mor
            '#f97316', // Turuncu
            '#06b6d4', // Turkuaz
            '#10b981'  // Emerald Yeşil
        ];

        // Renk atama mantığı
        const backgroundColors = rawLabels.map((label, index) => 
            severityPalette[label] || servicePalette[index % servicePalette.length]
        );

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: rawLabels,
                datasets: [{
                    data: {{ data|safe }},
                    backgroundColor: backgroundColors,
                    borderWidth: 3,
                    borderColor: '#ffffff',
                    hoverOffset: 25
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            usePointStyle: true, 
                            font: { size: 12, weight: '600', family: 'Plus Jakarta Sans' }, 
                            padding: 20,
                            font: { size: 12, weight: '600', family: 'Plus Jakarta Sans' }
                        } 
                    }
                },
                cutout: '75%',
                // Animasyon ekleyerek hocanın istediği şıklığı sağlıyoruz
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });
    });
</script>
{% endblock %}