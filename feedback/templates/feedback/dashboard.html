{% extends "base.html" %}

{% block title %}Service Management Intelligence{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container py-5">
    <div class="row mb-5 animate__animated animate__fadeIn">
        <div class="col-lg-12">
            <div class="main-banner p-5 rounded-5 border-0 shadow-lg text-white position-relative overflow-hidden text-start shadow-hover">
                <div class="position-relative z-index-2">
                    <h1 class="display-5 fw-bold mb-2">{% if is_admin %}Admin Global Dashboard{% else %}Service Owner Dashboard{% endif %}</h1>
                    <p class="lead opacity-75">Live monitoring & AI-optimized feedback analytics.</p>
                </div>
                <div class="banner-circle"></div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5 text-start d-flex align-items-stretch">
        <div class="col-md-8">
            <div class="row g-4 h-100">
                <div class="col-md-6">
                    <div class="card h-100 border-0 shadow-sm rounded-4 stat-card-premium bg-white p-4 hover-lift d-flex flex-column justify-content-center">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="text-muted small fw-bold text-uppercase mb-2">Total Feedbacks</h6>
                                <h2 class="fw-black text-dark mb-0">{{ feedbacks|length }}</h2>
                            </div>
                            <div class="icon-wrap bg-primary-subtle text-primary rounded-pill p-3"><i class="fas fa-comments fa-lg"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 border-0 shadow-sm rounded-4 stat-card-premium bg-white p-4 hover-lift d-flex flex-column justify-content-center">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="text-muted small fw-bold text-uppercase mb-2">AI Status</h6>
                                <h2 class="fw-black text-success mb-0">OPTIMIZED</h2>
                            </div>
                            <div class="icon-wrap bg-success-subtle text-success rounded-pill p-3"><i class="fas fa-robot fa-lg"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="card border-0 shadow-sm rounded-4 stat-card-premium bg-white p-4 hover-lift d-flex flex-column justify-content-center">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="text-muted small fw-bold text-uppercase mb-2">Data Privacy</h6>
                                <h2 class="fw-black text-info mb-0">ENABLED</h2>
                            </div>
                            <div class="icon-wrap bg-info-subtle text-info rounded-pill p-3"><i class="fas fa-user-shield fa-lg"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm rounded-4 bg-white p-4 text-center hover-lift d-flex flex-column">
                <h6 class="text-muted small fw-bold text-uppercase mb-3">Category Distribution</h6>
                <div class="flex-grow-1 d-flex align-items-center justify-content-center">
                    <canvas id="categoryChart" style="max-height: 250px; width: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 p-3 mb-4 bg-white shadow-hover">
        <form method="GET" class="row g-3 align-items-end text-start mx-1">
            <div class="col-lg-3">
                <label class="small fw-bold text-muted mb-1 ms-1">Keyword</label>
                <div class="input-group bg-light rounded-3">
                    <span class="input-group-text bg-transparent border-0 pe-0"><i class="fas fa-search text-muted small"></i></span>
                    <input type="text" name="q" value="{{ request.GET.q }}" class="form-control border-0 bg-transparent shadow-none ps-2" placeholder="Search...">
                </div>
            </div>
            <div class="col-lg-2">
                <label class="small fw-bold text-muted mb-1 ms-1">Start Date</label>
                <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="form-control border-0 bg-light shadow-none rounded-3">
            </div>
            <div class="col-lg-2">
                <label class="small fw-bold text-muted mb-1 ms-1">End Date</label>
                <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="form-control border-0 bg-light shadow-none rounded-3">
            </div>
            <div class="col-lg-2">
                <label class="small fw-bold text-muted mb-1 ms-1">Severity</label>
                <select name="severity" class="form-select border-0 bg-light shadow-none rounded-3 text-muted fw-medium">
                    <option value="" {% if not request.GET.severity %}selected{% endif %}>All Levels</option>
                    <option value="4" {% if request.GET.severity == "4" %}selected{% endif %}>Critical</option>
                    <option value="1" {% if request.GET.severity == "1" %}selected{% endif %}>Low</option>
                </select>
            </div>
            <div class="col-lg-3">
                <button type="submit" class="btn btn-primary w-100 rounded-3 fw-bold py-2 shadow-sm hover-push">FILTER </button>
            </div>
        </form>
    </div>

    <div class="card border-0 shadow-lg rounded-5 overflow-hidden animate__animated animate__slideInUp">
        <div class="table-responsive">
            <table class="table table-borderless align-middle mb-0">
                <thead>
                    <tr class="bg-light-subtle border-bottom">
                        <th class="ps-5 py-4 text-muted small fw-bold text-uppercase text-start">Service</th>
                        <th class="py-4 text-muted small fw-bold text-uppercase text-center">Severity</th>
                        <th class="py-4 text-muted small fw-bold text-uppercase text-center" style="width: 40%;">AI Optimized Content</th>
                        <th class="pe-5 py-4 text-muted small fw-bold text-uppercase text-end">Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fb in feedbacks %}
                    <tr class="hover-row-glow transition-all">
                        <td class="ps-5 text-start">
                            <div class="d-flex align-items-center">
                                <div class="avatar-icon text-white">{{ fb.service.name|slice:":1" }}</div>
                                <div class="ms-3">
                                    <div class="fw-bold text-dark">{{ fb.service.name }}</div>
                                    <small class="text-primary fw-bold" style="font-size: 0.65rem;">{{ fb.category|upper }}</small>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge rounded-pill px-3 py-2 
                                {% if fb.severity >= 4 %} bg-danger 
                                {% elif fb.severity == 3 %} bg-warning text-dark 
                                {% elif fb.severity == 2 %} bg-info-custom text-white 
                                {% else %} bg-success {% endif %}">
                                Level {{ fb.severity }}
                            </span>
                        </td>
                        <td class="text-center px-4">
                            <div class="p-3 rounded-4 bg-light border-0 ai-bubble shadow-sm w-100 transition-all">
                                <p class="mb-0 text-secondary small italic">
                                    {{ fb.normalized_text|default:fb.raw_text|truncatechars:150 }}
                                </p>
                            </div>
                        </td>
                        <td class="pe-5 text-end">
                            <div class="fw-bold text-dark small">{{ fb.date|date:"M d, Y" }}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">{{ fb.date|date:"H:i A" }}</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
    body { background-color: #f3f4f6; font-family: 'Plus Jakarta Sans', sans-serif; }
    .main-banner { background: linear-gradient(135deg, #0f172a 0%, #2563eb 100%); transition: 0.4s; }
    .banner-circle { position: absolute; top: -50px; right: -50px; width: 250px; height: 250px; background: rgba(255,255,255,0.1); border-radius: 50%; }
    
    .transition-all { transition: all 0.3s ease-in-out; }
    .hover-lift:hover { transform: translateY(-10px); box-shadow: 0 1rem 3rem rgba(0,0,0,0.1) !important; }
    .shadow-hover:hover { box-shadow: 0 10px 25px rgba(0,0,0,0.05) !important; }
    .hover-row-glow:hover { background-color: #ffffff !important; transform: scale(1.01); z-index: 10; position: relative; }
    .hover-row-glow:hover .ai-bubble { background-color: #fff !important; box-shadow: 0 5px 15px rgba(0,0,0,0.05) !important; }
    .hover-push:active { transform: scale(0.95); }

    .avatar-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-weight: 800; border-radius: 12px; background-color: #1e293b; }
    .ai-bubble { display: flex; align-items: center; justify-content: center; min-height: 80px; text-align: center; }
    .bg-info-custom { background-color: #0ea5e9 !important; }
    .fw-black { font-weight: 800; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                // 'Other' yerine views.py'dan gelen servis isimleri bağlandı
                labels: {{ labels|safe }},
                datasets: [{
                    data: {{ data|safe }},
                    backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            usePointStyle: true, 
                            font: { size: 11, weight: '600' },
                            padding: 20
                        } 
                    } 
                },
                cutout: '70%'
            }
        });
    });
</script>
{% endblock %}